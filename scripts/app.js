"use strict";angular.module("stormpathIdpApp",["ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/error",{templateUrl:"views/error.html",controller:"ErrorCtrl"}).when("/register",{templateUrl:"views/registration.html",controller:"RegistrationCtrl"}).when("/forgot",{templateUrl:"views/forgot.html",controller:"ForgotCtrl"}).when("/reset",{templateUrl:"views/reset.html",controller:"ResetCtrl"}).when("/verify",{templateUrl:"views/verify.html",controller:"VerifyCtrl"}).when("/unverified",{templateUrl:"views/unverified.html",controller:"UnverifiedCtrl"}).otherwise({redirectTo:"/"})}]).run(["$routeParams","$location","Stormpath",function(a,b,c){function d(a,b){var c=b.match(new RegExp(a+"=[^/&#]+","g"));return c&&c.length>0?c[0].split("=")[1]:null}c.init(function(){d("emailVerificationToken",b.absUrl())?b.path("verify"):d("passwordResetToken",b.absUrl())&&b.path("reset")})}]),angular.module("stormpathIdpApp").controller("LoginCtrl",["$scope","Stormpath","$window",function(a,b,c){function d(){c.fbAsyncInit=function(){var a=c.FB;a.init({appId:i.facebookAppId,xfbml:!0,status:!0,version:"v2.0"})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/es_LA/sdk.js",e.parentNode.insertBefore(d,e))}(c.document,"script","facebook-jssdk")}function e(){Object.keys(a.errors).map(function(b){a.errors[b]=!1})}function f(b){400===b.status?a.errors.badLogin=!0:404===b.status?a.errors.notFound=!0:b.userMessage||b.message?a.errors.userMessage=b.userMessage||b.message:a.errors.unknown=!0}function g(a,b){a?f(a):h(b.redirectTo)}function h(a){c.location=a}a.ready=!1,a.errors={badLogin:!1,notFound:!1,userMessage:!1,unknown:!1,googleReject:!1,facebookReject:!1};var i;return b.getAppConfig(function(b,c){b||(i=c,a.ready=!0,a.hasSocial=i.hasSocial,i.facebookAppId&&d())}),b.verifiedAccount&&(a.username=b.verifiedAccount.email),a.submit=function(){e(),a.username&&a.password&&b.login(a.username,a.password,g)},a.googleLogin=function(){var d=c.gapi;if(d){e();var f={clientid:i.googleClientId,scope:"https://www.googleapis.com/auth/plus.profile.emails.read",cookiepolicy:"single_host_origin",callback:function(c){c.status.signed_in?b.googleLogin(c.access_token,g):"access_denied"===c.error&&(a.errors.googleReject=!0)}};d.auth.signIn(f)}},a.facebookLogin=function(){var a=c.FB;a.getLoginStatus(function(c){"connected"===c.status?b.facebookLogin(c.authResponse.accessToken,g):a.login(function(a){"connected"===a.status&&b.facebookLogin(a.authResponse.accessToken,g)})})},a}]),angular.module("stormpathIdpApp").controller("RegistrationCtrl",["$scope",function(a){return a}]),angular.module("stormpathIdpApp").controller("ForgotCtrl",["$scope","Stormpath",function(a,b){a.sent=!1,a.fields={},a.submit=function(){a.notFound=!1;var c=Object.keys(a.fields).filter(function(b){return a.fields[b].validate()});c.length>0||b.sendPasswordResetEmail(a.fields.email.value,function(b){b?404===b.status?a.notFound=!0:a.unknownError=b:a.sent=!0})}}]),angular.module("stormpathIdpApp").controller("ResetCtrl",["$scope","Stormpath","$location",function(a,b,c){function d(a,b){var c=b.match(new RegExp(a+"=[^/&#]+","g"));return c&&c.length>0?c[0].split("=")[1]:null}a.status="loading",a.fields={};var e,f=d("passwordResetToken",c.absUrl());b.init(function(){b.verifyPasswordToken(f,function(b,c){b?404===b.status?a.status="expired":(a.status="failed",a.error=b.userMessage||b):(a.status="verified",e=c)})}),a.submit=function(){var c=Object.keys(a.fields).filter(function(b){var c=a.fields[b];return c.validate()}).length;c>0||(e.password=a.fields.password.value,b.saveAccount(e,function(c){if(c){var d=b.nicePasswordErrors[c.userMessage]||b.nicePasswordErrors[c.developerMessage];409===c.status?a.fields.username.errors.duplicateUser=!0:d?a.fields.password.errors.passwordPolicy=d:c.userMessage&&c.userMessage.toLowerCase().match(/password|account/)?a.fields.password.errors.passwordPolicy=c.userMessage:a.unknownError=c}else a.status="success"}))}}]),angular.module("stormpathIdpApp").controller("VerifyCtrl",["$scope","$location","Stormpath",function(a,b,c){function d(a,b){var c=b.match(new RegExp(a+"=[^/&#]+","g"));return c&&c.length>0?c[0].split("=")[1]:null}a.status="loading";var e=d("emailVerificationToken",b.absUrl());c.init(function(){c.verifyEmailToken(e,function(b){b?(a.status="failed",a.error=b.userMessage||b):a.status="verified"})})}]),angular.module("stormpathIdpApp").controller("ErrorCtrl",["$scope","Stormpath","$location",function(a,b,c){a.errors=angular.copy(b.errors),0===a.errors.length?c.path("/"):b.errors=[]}]),angular.module("stormpathIdpApp").service("Stormpath",["$window","$routeParams","$location","$rootScope",function(a,b,c,d){function e(a){k.errors.push(a.message||"Unknown"),c.path("/error")}var f,g,h=a.Stormpath,i=null,j=null;this.errors=[],this.getAppConfig=function(a){j?(c.path("/error"),a(j)):i?a(j,i):setTimeout(function(){i={logoUrl:"/images/logo.png",hasSocial:"false"===b.hasSocial?!1:!0,appHref:"https://api.stormpath.com/v1/applications/1234",googleClientId:"279686489820-bm1m1kd1dbdojvhmh4phhr6aofj95933.apps.googleusercontent.com",facebookAppId:"711511582223538"},j?d.$apply(function(){c.path("/error"),a(j)}):(d.logoUrl=i.logoUrl,d.$apply(function(){a(null,i)}))},200)};var k=this;k.registeredAccount=null,k.verifiedAccount=null;var l=!1,m=!1,n=[];return this.init=function(b){return l?void n.push(b):(m&&b(null),n.push(b),l=!0,void k.getAppConfig(function(b,c){if(b)e(b);else{try{f=new h.Client({appHref:c.appHref,headers:{"User-Agent":a.navigator.userAgent}})}catch(i){return void e(b)}f.getApplication(c.appHref,function(a,b){d.$apply(function(){a?e(a):(g=b,l=!1,m=!0,n.map(function(a){a(null)}))})})}}))},this.login=function(a,b,c){try{g.authenticateAccount({username:a,password:b},function(a,b){d.$apply(function(){c(a,b)})})}catch(f){e(f)}},this.register=function(a,b){try{g.createAccount(a,function(a,c){a||(k.registeredAccount=c),d.$apply(function(){b(a,c)})})}catch(c){e(c)}},this.verifyEmailToken=function(a,b){if(k.verifiedAccount)return void b(null,k.verifiedAccount);try{f.getCurrentTenant(function(c,e){if(c)throw c;e.verifyAccountEmail(a,function(a,c){a||(k.verifiedAccount=c),d.$apply(function(){b(a,c)})})})}catch(c){e(c)}},this.verifyPasswordToken=function(a,b){try{g.verifyPasswordResetToken(a,function(a,c){d.$apply(function(){b(a,c)})})}catch(c){e(c)}},this.sendPasswordResetEmail=function(a,b){try{g.sendPasswordResetEmail(a,function(a,c){d.$apply(function(){b(a,c)})})}catch(c){e(c)}},this.saveAccount=function(a,b){try{a.save(function(a,c){a||(k.verifiedAccount=c),d.$apply(function(){b(a,c)})})}catch(c){e(c)}},this.googleLogin=function(a,b){try{var c={providerData:{providerId:"google",code:a}};g.createAccount(c,function(a,c){a||(k.registeredAccount=c),d.$apply(function(){b(a,c)})})}catch(f){e(f)}},this.facebookLogin=function(a,b){try{var c={providerData:{providerId:"facebook",code:a}};g.createAccount(c,function(a,c){a||(k.registeredAccount=c),d.$apply(function(){b(a,c)})})}catch(f){e(f)}},this.nicePasswordErrors={"Password requires a numeric character!":"Password requires a number","Password requires an uppercase character!":"Password requires an uppercase letter","Account password minimum length not satisfied.":"Password is too short","Password requires a lowercase character!":"Password requires a lowercase letter"},this}]),angular.module("stormpathIdpApp").controller("RegistrationFormCtrl",["$scope","Stormpath","$location","$window",function(a,b,c,d){function e(a){"UNVERIFIED"===a.status?c.path("/unverified"):d.location.replace(a.redirectTo)}b.registeredAccount&&e(b.registeredAccount),a.fields={},a.submit=function(){a.unknownError=!1;var c=Object.keys(a.fields).filter(function(b){var c=a.fields[b];return c.validate()}),d=Object.keys(a.fields).reduce(function(b,c){return b[c]=a.fields[c].value,b},{});delete d.passwordConfirm,0===c.length&&b.register(d,function(c,d){if(c){var f=b.nicePasswordErrors[c.userMessage]||b.nicePasswordErrors[c.developerMessage];409===c.status?a.fields.username.errors.duplicateUser=!0:f?a.fields.password.errors.passwordPolicy=f:c.userMessage&&c.userMessage.toLowerCase().match(/password|account/)?a.fields.password.errors.passwordPolicy=c.userMessage:a.unknownError=c}else e(d)})}}]),angular.module("stormpathIdpApp").directive("formGroup",function(){return{restrict:"A",scope:!0,link:function(a,b,c){a.validationError=!1,a.errors={},a.$watch("validationError",function(){b.toggleClass(c.errorClass||"has-error",a.validationError)}),a.$watchCollection("errors",function(){var d=Object.keys(a.errors).filter(function(b){return a.errors[b]}).length;b.toggleClass(c.errorClass||"has-error",a.validationError||d>0)})}}}),angular.module("stormpathIdpApp").directive("formControl",function(){return{restrict:"A",link:function(a,b,c){var d=c.name;a.fields||(a.fields={}),a.fields[d]={value:b.val(),validationError:!1,errors:a.errors||{},validate:function(){return"function"==typeof a.validate?a.validate(b):!0}},a.clearErrors=function(){Object.keys(a.errors).map(function(b){a.errors[b]=!1})},b.on("input",function(){a.$apply(function(a){a.fields[d].value=b.val()})}),a.$watchCollection("errors",function(b){angular.extend(a.fields[d].errors,b||{})}),a.$watchCollection("fields."+d,function(a){b.val(a.value)}),a.$watchCollection("fields."+d+".errors",function(b){angular.extend(a.errors,b||{})})}}}),angular.module("stormpathIdpApp").directive("validateOnBlur",function(){return{restrict:"A",link:function(a,b){b.on("blur",function(){a.$apply(function(){a.validate(b)})})}}}),angular.module("stormpathIdpApp").directive("nameValidation",function(){return{restrict:"A",link:function(a){a.validate=function(b){a.clearErrors();var c=""===b.val();return a.validationError=c,c}}}}),angular.module("stormpathIdpApp").directive("emailValidation",function(){var a=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return{restrict:"A",link:function(b){b.validate=function(c){b.clearErrors();var d=""===c.val()?!0:!a.test(c.val());return b.validationError=d,d}}}}),angular.module("stormpathIdpApp").directive("passwordMatchValidation",function(){return{restrict:"A",link:function(a){a.validate=function(b){var c=""!==a.fields.password.value&&b.val()!==a.fields.password.value;return a.validationError=c,c}}}}),angular.module("stormpathIdpApp").controller("UnverifiedCtrl",["$scope","Stormpath","$location",function(a,b,c){var d=b.registeredAccount;d&&"UNVERIFIED"===d.status||c.path("/")}]);